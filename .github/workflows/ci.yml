name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.CI_MYSQL_ROOT_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install Frappe Bench
        run: pip install frappe-bench
       
      - name: Install Redis
         run: sudo apt-get update && sudo apt-get install -y redis-server

     - name: Create Frappe Bench
        run: bench init --frappe-branch ${{ secrets.CI_FRAPPE_VERSION }} ci-bench     
     
      - name: Create Frappe Bench
        run: |
          bench init --frappe-branch ${{ secrets.CI_FRAPPE_VERSION }} ci-bench
          cd ci-bench
          bench get-app erpnext --branch ${{ secrets.CI_ERPNEXT_VERSION }} --resolve-deps
          bench new-site ${{ secrets.CI_FRAPPE_SITE_NAME }} \
            --admin-password ${{ secrets.CI_ADMIN_PASSWORD }} \
            --mariadb-root-password ${{ secrets.CI_MYSQL_ROOT_PASSWORD }}
          bench --site ${{ secrets.CI_FRAPPE_SITE_NAME }} install-app erpnext
          bench get-app my_custom_app https://github.com/anirudha16/my_custom_app.git
          bench --site ${{ secrets.CI_FRAPPE_SITE_NAME }} install-app my_custom_app

